<<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shapes Fighter</title>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: none; user-select: none; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        #selection-screen { position: fixed; inset: 0; background: #111; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .row { display: flex; gap: 8px; margin: 10px; }
        .btn-sel { padding: 12px; border: 2px solid #444; background: #222; color: white; border-radius: 8px; width: 95px; font-weight: bold; font-size: 0.7rem; }
        .selected-p1 { border-color: #0cf !important; box-shadow: 0 0 10px #0cf; }
        .selected-p2 { border-color: #f22 !important; box-shadow: 0 0 10px #f22; }
        #btn-luchar { padding: 18px 40px; background: #0a0; border: none; border-radius: 30px; color: white; font-size: 1.1rem; font-weight: bold; display: none; margin-top: 20px; }

        #game-area { position: relative; flex: 1; background: #080808; border-bottom: 2px solid #333; }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; z-index: 5; }
        .bar-wrap { width: 42%; }
        .bar { height: 10px; background: #222; border: 1px solid #fff; border-radius: 5px; overflow: hidden; margin-bottom: 3px; }
        .hp { background: #f22; width: 100%; height: 100%; transition: width 0.2s; }
        .mp { background: #0cf; width: 0%; height: 100%; transition: width 0.2s; }

        .controls { display: flex; height: 210px; background: #111; }
        .pad { width: 50%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 10px; border: 1px solid #222; }
        .btn-game { border: none; background: #333; color: white; border-radius: 10px; font-weight: bold; font-size: 1.2rem; }
        .btn-atk { background: #822; }
        .btn-k { background: #626; }
        .btn-u { grid-column: span 3; background: #147; font-size: 0.9rem; }

        #ko-overlay { position: absolute; top: 30%; width: 100%; text-align: center; display: none; pointer-events: none; }
        #ko-text { font-size: 4rem; color: #ff0; text-shadow: 0 0 20px #f00; font-weight: bold; margin: 0; }
        #replay-btn { position: absolute; top: 60%; left: 50%; transform: translateX(-50%); padding: 15px 35px; background: #fff; border: none; border-radius: 30px; font-weight: bold; display: none; z-index: 200; color: #000; }
    </style>
</head>
<body>

<div id="selection-screen">
    <h2>SHAPES FIGHTER</h2>
    <p style="color:#0cf;">P1 SELECCIONA</p>
    <div class="row">
        <button class="btn-sel p1-opt" onclick="sel(1,'sq',this)">CUADRADO</button>
        <button class="btn-sel p1-opt" onclick="sel(1,'ci',this)">CILINDRO</button>
        <button class="btn-sel p1-opt" onclick="sel(1,'tr',this)">TRIÁNGULO</button>
    </div>
    <p style="color:#f22;">P2 SELECCIONA</p>
    <div class="row">
        <button class="btn-sel p2-opt" onclick="sel(2,'sq',this)">CUADRADO</button>
        <button class="btn-sel p2-opt" onclick="sel(2,'ci',this)">CILINDRO</button>
        <button class="btn-sel p2-opt" onclick="sel(2,'tr',this)">TRIÁNGULO</button>
    </div>
    <button id="btn-luchar" onclick="iniciarCombate()">¡A LUCHAR!</button>
</div>

<div id="game-area" class="hidden">
    <div id="ui">
        <div class="bar-wrap"><div class="bar"><div id="hp1" class="hp"></div></div><div class="bar"><div id="mp1" class="mp"></div></div></div>
        <div class="bar-wrap"><div class="bar"><div id="hp2" class="hp"></div></div><div class="bar"><div id="mp2" class="mp"></div></div></div>
    </div>
    <div id="ko-overlay"><p id="ko-text">K.O.</p></div>
    <button id="replay-btn" onclick="location.reload()">VOLVER A JUGAR</button>
    <canvas id="c"></canvas>
</div>

<div id="controls-bar" class="controls hidden">
    <div class="pad">
        <button class="btn-game" onpointerdown="mv(1,-1)" onpointerup="mv(1,0)">←</button>
        <button class="btn-game" onpointerdown="jp(1)">↑</button>
        <button class="btn-game" onpointerdown="mv(1,1)" onpointerup="mv(1,0)">→</button>
        <button class="btn-game btn-atk" onpointerdown="at(1,'p')">P</button>
        <button class="btn-game btn-k" onpointerdown="at(1,'k')">K</button>
        <button class="btn-game btn-u" onpointerdown="at(1,'u')">ULTRA</button>
    </div>
    <div class="pad">
        <button class="btn-game" onpointerdown="mv(2,-1)" onpointerup="mv(2,0)">←</button>
        <button class="btn-game" onpointerdown="jp(2)">↑</button>
        <button class="btn-game" onpointerdown="mv(2,1)" onpointerup="mv(2,0)">→</button>
        <button class="btn-game btn-atk" onpointerdown="at(2,'p')">P</button>
        <button class="btn-game btn-k" onpointerdown="at(2,'k')">K</button>
        <button class="btn-game btn-u" onpointerdown="at(2,'u')">ULTRA</button>
    </div>
</div>

<script>
let p1s, p2s, gameOn = false, isKO = false;
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

function sel(p, s, b) {
    if(p===1) { p1s=s; document.querySelectorAll('.p1-opt').forEach(x=>x.classList.remove('selected-p1')); b.classList.add('selected-p1'); }
    else { p2s=s; document.querySelectorAll('.p2-opt').forEach(x=>x.classList.remove('selected-p2')); b.classList.add('selected-p2'); }
    if(p1s && p2s) document.getElementById('btn-luchar').style.display = 'block';
}

class Fighter {
    constructor(id, x, color, shape) {
        this.id = id; this.x = x; this.y = 0; this.w = 40; this.h = 60;
        this.color = color; this.shape = shape; this.hp = 100; this.mp = 0;
        this.dy = 0; this.dx = 0; this.state = 'idle'; this.t = 0; this.mode = 'fight';
        this.hitTimer = 0;
    }
    
    drawFace(size) {
        ctx.fillStyle = "black";
        // Ojos (estilo tu icono)
        if (this.hitTimer > 0) {
            // Cara de dolor (X X)
            ctx.font = "bold 15px Arial";
            ctx.fillText("X", -10, -5);
            ctx.fillText("X", 5, -5);
        } else {
            // Ojos normales
            ctx.beginPath(); ctx.arc(-8, -8, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(8, -8, 3, 0, Math.PI*2); ctx.fill();
        }
        // Boca (estilo tu icono)
        ctx.beginPath();
        if (this.hitTimer > 0) ctx.arc(0, 8, 5, 0, Math.PI, true); // Cara triste/dolor
        else ctx.arc(0, 10, 6, 0, Math.PI); // Boca abierta de pelea
        ctx.fill();
    }

    draw() {
        this.t += 0.2;
        if(this.hitTimer > 0) this.hitTimer--;
        
        ctx.save();
        ctx.translate(this.x + this.w/2, this.y + this.h/2);
        
        // Efecto de parpadeo rojo si recibe daño
        ctx.fillStyle = (this.hitTimer > 0) ? "white" : this.color;
        
        if (this.mode === 'win') { ctx.translate(0, Math.sin(this.t*3)*15); ctx.rotate(Math.sin(this.t)*0.2); }
        else if (this.mode === 'lose') { ctx.scale(1, 0.5); ctx.translate(0, 20); }

        if (this.shape === 'sq') {
            if(this.state === 'p') ctx.scale(1.5, 0.7);
            ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
        } 
        else if (this.shape === 'ci') {
            if(this.state === 'k' || this.state === 'u') ctx.rotate(this.t*2);
            ctx.beginPath(); ctx.ellipse(0, 0, this.w/2, this.h/2, 0, 0, Math.PI*2); ctx.fill();
        } 
        else if (this.shape === 'tr') {
            if(this.state === 'p') { ctx.rotate(Math.PI/2); ctx.scale(1.4, 0.8); }
            if(this.state === 'k') ctx.rotate(this.t*5);
            if(this.state === 'u') { ctx.scale(2, 2); ctx.fillStyle = "#ff0"; }
            ctx.beginPath(); ctx.moveTo(0, -this.h/2); ctx.lineTo(-this.w/2, this.h/2); ctx.lineTo(this.w/2, this.h/2); ctx.closePath(); ctx.fill();
        }
        
        this.drawFace();
        ctx.restore();
    }

    update() {
        if(!isKO) {
            this.x += this.dx; this.y += this.dy;
            if (this.y + this.h < canvas.height) this.dy += 0.8;
            else { this.dy = 0; this.y = canvas.height - this.h; }
            this.x = Math.max(0, Math.min(canvas.width - this.w, this.x));
        }
        this.draw();
    }
}

let f1, f2;
function iniciarCombate() {
    document.getElementById('selection-screen').style.display = 'none';
    document.getElementById('game-area').classList.remove('hidden');
    document.getElementById('controls-bar').classList.remove('hidden');
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    f1 = new Fighter(1, 60, '#0cf', p1s);
    f2 = new Fighter(2, canvas.width - 100, '#f22', p2s);
    gameOn = true; loop();
}

function loop() {
    ctx.fillStyle = "rgba(10,10,10,0.4)"; ctx.fillRect(0,0,canvas.width, canvas.height);
    f1.update(); f2.update();
    if(gameOn) requestAnimationFrame(loop);
}

window.mv = (p, d) => { if(!isKO) (p===1?f1:f2).dx = d*6; };
window.jp = (p) => { if(!isKO) { let f=(p===1?f1:f2); if(f.y >= canvas.height-f.h) f.dy = -15; }};
window.at = (p, type) => {
    if(isKO) return;
    let a=(p===1?f1:f2), d=(p===1?f2:f1);
    if(type==='u' && a.mp < 100) return;
    
    a.state = type;
    setTimeout(() => a.state = 'idle', 250);

    if(Math.abs(a.x - d.x) < 95) {
        let dmg = (type==='u'?45 : (type==='k'?15 : 8));
        d.hp = Math.max(0, d.hp - dmg);
        d.hitTimer = 10; // Activa cara de dolor
        if(type!=='u') a.mp = Math.min(100, a.mp + 25); else a.mp = 0;
        
        document.getElementById('hp1').style.width = f1.hp + "%";
        document.getElementById('hp2').style.width = f2.hp + "%";
        document.getElementById('mp1').style.width = f1.mp + "%";
        document.getElementById('mp2').style.width = f2.mp + "%";

        if(d.hp <= 0) {
            isKO = true; a.mode = 'win'; d.mode = 'lose';
            a.x = canvas.width/2 - 60; d.x = canvas.width/2 + 20;
            document.getElementById('ko-overlay').style.display = 'block';
            setTimeout(() => document.getElementById('replay-btn').style.display = 'block', 1200);
        }
    }
};
</script>
</body>
</html>